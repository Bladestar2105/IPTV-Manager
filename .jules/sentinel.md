## 2024-05-23 - SSRF in HLS Segment Proxy
**Vulnerability:** The `proxySegment` endpoint in `streamController.js` accepted a target URL via an encrypted payload but did not validate it against private IPs. This allowed a malicious or compromised upstream provider to inject private IP URLs into their HLS playlist, causing the server to proxy requests to its own local network (SSRF).
**Learning:** Encryption only ensures integrity and authenticity of the payload (that it was generated by us), but it does not guarantee that the *data inside* (which originated from the upstream provider's playlist) is safe. We must treat data from external providers as untrusted, even if we wrapped it ourselves.
**Prevention:** Always validate URLs against SSRF (using `isSafeUrl` or similar) right before making the request. When supporting legitimate private upstreams, use an explicit "allow" flag derived from the trusted admin configuration (the provider's base URL) rather than disabling protection globally or blindly trusting the payload.

## 2024-05-24 - Unrestricted Image Proxy DoS
**Vulnerability:** The `/api/proxy/image` endpoint used `await response.arrayBuffer()` to download images for caching, loading the entire file into memory without size limits. This allowed authenticated users to crash the server (Memory Exhaustion) by requesting a large file.
**Learning:** `fetch` response methods like `arrayBuffer()`, `text()`, and `json()` buffer the entire response body. When handling user-controlled URLs (like in a proxy), always use streams and enforce a size limit to prevent memory exhaustion.
**Prevention:** Check `Content-Length` headers first (if available), and process the response body as a stream, counting bytes and aborting if a threshold (e.g., 5MB) is exceeded.

## 2024-05-25 - Incomplete SSRF Protection in Helper
**Vulnerability:** The `isUnsafeIP` utility function only blocked a subset of private IP ranges, missing critical RFC 1918 ranges like `10.0.0.0/8`, `172.16.0.0/12`, and `192.168.0.0/16`. This allowed attackers to bypass SSRF protections by using these unblocked private IPs.
**Learning:** Blacklisting specific IPs manually is error-prone. It's easy to miss ranges or forget edge cases (like IPv6 ULA or mapped addresses).
**Prevention:** Use a comprehensive, standard library or a well-maintained list of all reserved IP ranges (RFC 1918, RFC 4193, RFC 6598) for SSRF protection. Regularly audit network validation logic against known reserved ranges.
